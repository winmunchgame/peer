 <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Send - Stream & Watch</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- LUCIDE ICONS (For MX Player Look) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #075e54; --secondary: #128c7e; --bg: #e5ddd5; --white: #ffffff;
            --text: #000000; --msg-sent: #dcf8c6; --msg-recv: #ffffff; --border: #ddd;
            --red: #ff4b4b; --green: #25d366; --blue: #3498db; --overlay-bg: rgba(0,0,0,0.7);
        }
        body.dark-mode {
            --primary: #1f2c34; --secondary: #00af9c; --bg: #0b141a; --white: #111b21;
            --text: #e9edef; --msg-sent: #005c4b; --msg-recv: #202c33; --border: #2a3942;
        }
        body { background: var(--bg); height: 100dvh; display: flex; justify-content: center; overflow: hidden; color: var(--text); transition: background 0.3s; }
        .app-container { width: 100%; max-width: 1000px; height: 100%; background: var(--white); display: flex; box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); position: relative; transition: background 0.3s; }

        /* SIDEBAR */
        .sidebar { width: 350px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--white); transition: transform 0.3s ease; z-index: 100; }
        .header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; height: 60px; flex-shrink: 0; }
        .status-badge { font-size: 12px; background: rgba(255, 255, 255, 0.2); padding: 4px 8px; border-radius: 12px; color: white; }
        .connect-panel { padding: 20px; text-align: center; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        #qrcode { background: white; padding: 10px; display: inline-block; border-radius: 8px; margin-bottom: 15px; }
        #qrcode img { display: block; max-width: 100%; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; margin: 5px; transition: 0.2s; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-outline { border: 1px solid var(--secondary); color: var(--secondary); background: transparent; }
        
        /* STREAM BUTTON */
        .stream-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; width: 90%; padding: 15px; border-radius: 12px; border: none;
            font-size: 16px; font-weight: bold; cursor: pointer; margin: 15px auto;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4); 
            transition: transform 0.2s;
        }
        .stream-btn:active { transform: scale(0.98); }

        /* FILES */
        .files-panel { padding: 15px; background: var(--white); border-top: 1px solid var(--border); display: flex; flex-direction: column; flex-grow: 1; min-height: 0; max-height: 50%; }
        .files-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; align-items: center; }
        .magic-btn-small { padding: 8px 15px; border-radius: 8px; background: var(--white); border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 13px; color: var(--text); }
        #transfer-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 5px; }
        .transfer-item { background: var(--msg-recv); padding: 10px; border-radius: 6px; border: 1px solid var(--border); font-size: 13px; color: var(--text); }
        .t-bar-fill { height: 6px; background: var(--green); width: 0%; border-radius: 3px; transition: width 0.2s; margin-top: 5px; }

        /* CHAT AREA */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--bg); position: relative; }
        body:not(.dark-mode) .chat-area { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .chat-header { padding: 10px 15px; background: var(--white); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; height: 60px; flex-shrink: 0; }
        .chat-user { display: flex; align-items: center; gap: 10px; }
        .theme-toggle-btn { background: none; border: none; font-size: 20px; cursor: pointer; margin-right: 5px; }
        .messages { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); word-break: break-word; color: var(--text); }
        .msg.sent { align-self: flex-end; background: var(--msg-sent); color: body.dark-mode ? #e9edef : #000; }
        .msg.received { align-self: flex-start; background: var(--msg-recv); }
        .input-area { padding: 10px; background: var(--white); display: flex; align-items: center; gap: 8px; flex-shrink: 0; border-top: 1px solid var(--border); }
        #msg-input { flex-grow: 1; padding: 12px; border: none; border-radius: 20px; outline: none; font-size: 15px; background: var(--bg); color: var(--text); }
        .send-btn { background: var(--secondary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* --- MX PLAYER STYLE THEATER MODE --- */
        #theater-mode {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000; display: none;
            flex-direction: column; overflow: hidden;
        }
        
        .video-wrapper {
            position: relative; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: #000;
        }

        /* Main Video Element */
        #main-video {
            width: 100%; height: 100%;
            object-fit: contain; /* Default */
            transition: object-fit 0.3s ease;
        }

        /* Controls Overlay (Hidden by default, shown on hover/tap) */
        .controls-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 20%, rgba(0,0,0,0) 80%, rgba(0,0,0,0.8) 100%);
            display: flex; flex-direction: column; justify-content: space-between;
            opacity: 1; transition: opacity 0.3s;
            pointer-events: none; /* Let clicks pass through to video for toggle */
        }
        .controls-overlay.hidden { opacity: 0; }
        .controls-overlay > * { pointer-events: auto; } /* Re-enable clicks on controls */

        /* Top Bar */
        .player-top {
            padding: 20px; display: flex; justify-content: space-between; align-items: center; color: white;
        }
        .movie-title { font-size: 16px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%; }

        /* Center Play/Pause (Big) */
        .player-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; gap: 40px; align-items: center;
        }
        .center-btn {
            background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.3);
            color: white; border-radius: 50%; width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            backdrop-filter: blur(5px); transition: 0.2s;
        }
        .center-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .play-pause-lg { width: 80px; height: 80px; background: rgba(0,0,0,0.6); border-color: white; }

        /* Bottom Controls */
        .player-bottom { padding: 20px; color: white; display: flex; flex-direction: column; gap: 10px; }
        
        .progress-container { display: flex; align-items: center; gap: 10px; font-size: 12px; }
        .progress-bar {
            flex-grow: 1; height: 5px; background: rgba(255,255,255,0.3);
            border-radius: 5px; cursor: pointer; position: relative;
        }
        .progress-filled {
            height: 100%; background: var(--blue); border-radius: 5px; width: 0%;
            position: relative;
        }
        .progress-thumb {
            width: 12px; height: 12px; background: white; border-radius: 50%;
            position: absolute; right: -6px; top: -3.5px; box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .control-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .btn-group { display: flex; gap: 20px; align-items: center; }
        .player-icon-btn { background: none; border: none; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; font-size: 10px; opacity: 0.8; transition: 0.2s; }
        .player-icon-btn:hover { opacity: 1; }
        .player-icon-btn svg { width: 24px; height: 24px; }
        .player-icon-btn.active { color: var(--green); }
        .player-icon-btn.active-red { color: var(--red); }

        /* PIP Videos */
        .pip-wrapper {
            position: absolute; top: 70px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 5005;
        }
        .pip-video {
            width: 100px; height: 140px; background: #333; border: 2px solid rgba(255,255,255,0.5);
            border-radius: 12px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.3s; cursor: move;
        }
        .pip-video.hidden { opacity: 0; pointer-events: none; height: 0; border: none; }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: 100%; position: absolute; transform: translateX(0); }
            .sidebar.hidden { transform: translateX(-100%); }
            .mobile-only { display: block; }
            .pip-video { width: 80px; height: 110px; }
            .player-center { gap: 20px; }
            .center-btn { width: 50px; height: 50px; }
            .play-pause-lg { width: 65px; height: 65px; }
        }
    </style>
</head>

<body>
    <!-- NOTIFICATION SOUND -->
    <audio id="msg-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <!-- MX PLAYER STYLE THEATER MODE -->
    <div id="theater-mode">
        <div class="video-wrapper" id="video-wrapper" onclick="toggleControls()">
            <!-- Main Video Element (Acts as Source for Host, and Stream Display for Peer) -->
            <video id="main-video" playsinline></video>

            <!-- PiP Videos (User & Peer) -->
            <div class="pip-wrapper" id="pip-wrapper">
                <video id="peer-pip" class="pip-video" autoplay playsinline></video>
                <video id="self-pip" class="pip-video" autoplay playsinline muted></video>
            </div>

            <!-- Controls Overlay -->
            <div class="controls-overlay" id="controls-overlay" onclick="event.stopPropagation()">
                <!-- Top Bar -->
                <div class="player-top">
                    <button class="player-icon-btn" onclick="exitTheater()">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <span class="movie-title" id="movie-title">Live Stream</span>
                    <div class="btn-group">
                        <button class="player-icon-btn" onclick="toggleFit()" title="Screen Fit">
                            <i data-lucide="maximize"></i>
                        </button>
                        <button class="player-icon-btn" onclick="toggleLock()" title="Lock Controls">
                            <i data-lucide="lock" id="lock-icon"></i>
                        </button>
                    </div>
                </div>

                <!-- Center Controls -->
                <div class="player-center" id="center-controls">
                    <button class="center-btn" onclick="seekRelative(-10)">
                        <i data-lucide="rotate-ccw"></i>
                    </button>
                    <button class="center-btn play-pause-lg" onclick="togglePlay()">
                        <i data-lucide="play" id="center-play-icon"></i>
                    </button>
                    <button class="center-btn" onclick="seekRelative(10)">
                        <i data-lucide="rotate-cw"></i>
                    </button>
                </div>

                <!-- Bottom Controls -->
                <div class="player-bottom" id="bottom-controls">
                    <div class="progress-container">
                        <span id="curr-time">00:00</span>
                        <div class="progress-bar" id="progress-bar" onclick="seekTo(event)">
                            <div class="progress-filled" id="progress-filled">
                                <div class="progress-thumb"></div>
                            </div>
                        </div>
                        <span id="total-time">00:00</span>
                    </div>

                    <div class="control-row">
                        <!-- Call Controls (Integrated) -->
                        <div class="btn-group">
                            <button id="tm-mic" class="player-icon-btn" onclick="toggleMic()">
                                <i data-lucide="mic"></i><span>Mic</span>
                            </button>
                            <button id="tm-cam" class="player-icon-btn" onclick="toggleCam()">
                                <i data-lucide="camera"></i><span>Cam</span>
                            </button>
                        </div>

                        <!-- Add File (Host Only) -->
                        <div class="btn-group" id="host-controls">
                            <button class="player-icon-btn" onclick="document.getElementById('movie-file').click()">
                                <i data-lucide="folder-open"></i><span>Open</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="header">
                <div style="display:flex; align-items:center;">
                    <button class="mobile-only btn" style="background:none; color:white; padding:0; margin-right:10px;" onclick="toggleSidebar()">‚Üê</button>
                    <h2>QR Send</h2>
                </div>
                <div style="display:flex; align-items:center;">
                    <button class="theme-toggle-btn" onclick="toggleTheme()" style="background:none; border:none; font-size:20px; cursor:pointer; margin-right:5px;">üåì</button>
                    <span id="status-badge" class="status-badge">Disconnected</span>
                </div>
            </div>

            <div class="connect-panel" id="connect-panel">
                <div id="qrcode"></div>
                <p style="color:#666; margin-bottom:10px; font-size:13px;">Scan to connect</p>
                <div style="display:flex; justify-content:center; gap:5px;">
                    <button class="btn btn-outline" onclick="shareQRCode()">üîó Share</button>
                    <button class="btn btn-primary" onclick="startScanner()">üì∑ Scan</button>
                </div>
            </div>

            <!-- STREAM MOVIE BUTTON -->
            <button class="stream-btn" onclick="document.getElementById('movie-file').click()">
                <i data-lucide="tv-2"></i> Stream Movie Party
            </button>
            <input type="file" id="movie-file" accept="video/*, .mkv, .mp4" style="display:none" onchange="startHosting(this)">

            <div class="files-panel" id="files-panel">
                <div class="files-header">
                    <span>File Transfer</span>
                    <button class="magic-btn-small" onclick="document.getElementById('file-input').click()">üìÇ Send File</button>
                </div>
                <input type="file" id="file-input" multiple>
                <div id="transfer-list"></div>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="chat-area" id="chat-area">
            <div class="chat-header">
                <div class="chat-user">
                    <button class="mobile-only btn" style="background:none; font-size:20px; padding:0; margin-right:10px;" onclick="toggleSidebar()">üìÇ</button>
                    <div>
                        <div style="font-weight:bold;">Peer</div>
                        <div style="font-size:11px; color:#666;" id="connection-status">Waiting...</div>
                    </div>
                </div>
            </div>

            <div class="messages" id="messages"></div>

            <div class="input-area">
                <button class="btn" style="background:none; color:var(--secondary); padding:5px;" onclick="document.getElementById('img-input').click()">üì∑</button>
                <input type="file" id="img-input" accept="image/*" style="display:none">
                <input type="text" id="msg-input" placeholder="Message...">
                <button class="send-btn" onclick="sendText()">‚û§</button>
            </div>
        </div>
    </div>

    <!-- SCANNER OVERLAY -->
    <div id="scanner-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:4000; display:none; flex-direction:column;">
        <div style="position:absolute; top:20px; right:20px; font-size:30px; color:white; cursor:pointer;" onclick="stopScanner()">‚úï</div>
        <div id="qr-reader" style="width:100%; flex-grow:1;"></div>
    </div>

    <!-- IMAGE MODAL -->
    <div id="img-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4000; display:none; justify-content:center; align-items:center; flex-direction:column;">
        <div style="position:absolute; top:20px; right:20px; font-size:30px; color:white; cursor:pointer;" onclick="document.getElementById('img-modal').style.display='none'">‚úï</div>
        <img id="modal-img" style="max-width:90%; max-height:80%; border-radius:8px;">
        <a id="modal-dl" style="color:white; margin-top:20px; text-decoration:underline;" download>Download</a>
    </div>

    <script>
        let peer, conn, myId;
        let localStream, activeCall;
        let isHost = false; 
        let controlsTimeout;
        let isLocked = false;
        
        // Track remote peer's duration for UI syncing
        let peerDuration = 0;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (window.innerWidth < 768) document.querySelector('.mobile-only').style.display = 'block';
            if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
            initApp();

            document.getElementById('msg-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendText(); });
            
            document.getElementById('img-input').addEventListener('change', function() {
                const file = this.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const id = Date.now();
                        if(conn) conn.send({type:'image', content:e.target.result, id:id});
                        addImage(e.target.result, 'sent', id);
                    };
                    reader.readAsDataURL(file);
                }
                this.value = '';
            });

            makeDraggable(document.getElementById('pip-wrapper'));
        });

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }

        function initApp() {
            const hash = window.location.hash.substring(1);
            const peerConfig = { debug: 1, config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478' }] } };
            peer = new Peer(undefined, peerConfig);

            peer.on('open', (id) => {
                myId = id;
                if (!hash) {
                    new QRCode(document.getElementById('qrcode'), { text: window.location.href + '#' + id, width: 180, height: 180 });
                } else {
                    document.getElementById('connect-panel').style.display = 'none';
                    document.getElementById('connection-status').innerText = 'Connecting...';
                    setTimeout(() => {
                        conn = peer.connect(hash);
                        setupConnection(conn);
                    }, 1000);
                    if(window.innerWidth < 768) toggleSidebar();
                }
            });

            peer.on('connection', (c) => { setupConnection(c); });
            
            peer.on('call', (call) => {
                const type = call.metadata?.type;
                
                if (type === 'movie-stream') {
                    // RECEIVER (Peer B) Logic
                    isHost = false; 
                    enterTheaterMode();
                    document.getElementById('host-controls').style.display = 'none';
                    document.getElementById('movie-title').innerText = "Watching Peer's Movie";
                    
                    call.answer(); 
                    call.on('stream', (remoteStream) => {
                        const vid = document.getElementById('main-video');
                        vid.srcObject = remoteStream;
                        // Important: Ensure playing
                        vid.play().catch(e => console.log("Auto-play blocked", e));
                    });
                } else {
                    // Face Call Logic
                    const vidConstraint = { width: { ideal: 320 }, height: { ideal: 240 } }; // Low res for PiP is enough
                    navigator.mediaDevices.getUserMedia({video: vidConstraint, audio:true}).then(stream => {
                        localStream = stream;
                        document.getElementById('self-pip').srcObject = stream;
                        call.answer(stream);
                        activeCall = call;
                        call.on('stream', (remoteStream) => {
                            document.getElementById('peer-pip').srcObject = remoteStream;
                        });
                    }).catch(e => console.error("Call error", e));
                }
            });
        }

        function setupConnection(c) {
            conn = c;
            conn.on('open', () => {
                document.getElementById('status-badge').innerText = 'Connected';
                document.getElementById('status-badge').style.background = 'var(--green)';
                document.getElementById('connect-panel').style.display = 'none';
                document.getElementById('connection-status').innerText = 'Online';
                if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
            });
            conn.on('data', handleData);
            conn.on('close', () => alert("Peer disconnected"));
        }

        function handleData(data) {
            switch(data.type) {
                case 'text': addMessage(data.content, 'received'); document.getElementById('msg-sound').play(); break;
                case 'image': addImage(data.content, 'received', data.id); document.getElementById('msg-sound').play(); break;
                case 'file-meta': startReceivingFile(data); break;
                case 'file-chunk': processFileChunk(data); break;
                
                // HOST RECEIVING COMMANDS FROM PEER
                case 'remote-command': 
                    if(isHost) {
                        const vid = document.getElementById('main-video');
                        if(data.action === 'play') vid.play();
                        else if(data.action === 'pause') vid.pause();
                        else if(data.action === 'seek') vid.currentTime = data.time;
                    }
                    break;
                
                // PEER RECEIVING INFO FROM HOST
                case 'stream-info': 
                    if(!isHost) {
                        peerDuration = data.duration;
                        updateProgressUI(data.time, data.duration);
                        // Also sync play status icon
                        updatePlayIcon(data.isPlaying);
                        
                        // Force sync if lag is huge (e.g. paused vs playing state mismatch)
                        // Note: We can't force stream time, but we can pause our player if stream stops
                        const vid = document.getElementById('main-video');
                        if(!data.isPlaying && !vid.paused) vid.pause();
                        if(data.isPlaying && vid.paused) vid.play().catch(e=>{});
                    }
                    break;
            }
        }

        // --- HOSTING LOGIC (USER A) ---
        function startHosting(input) {
            const file = input.files[0];
            if(!file) return;
            isHost = true;
            
            const url = URL.createObjectURL(file);
            const mainVid = document.getElementById('main-video');
            
            // Host plays the file DIRECTLY
            mainVid.src = url;
            mainVid.muted = false; // HOST MUST HEAR AUDIO
            document.getElementById('movie-title').innerText = file.name;
            
            // Create Stream from the playing video
            // We use a slight delay to ensure video is ready
            mainVid.oncanplay = () => {
                let stream;
                if (mainVid.captureStream) stream = mainVid.captureStream(30);
                else if (mainVid.mozCaptureStream) stream = mainVid.mozCaptureStream(30);
                
                if(stream && conn) {
                    peer.call(conn.peer, stream, {metadata: {type: 'movie-stream'}});
                }
            };

            enterTheaterMode();
            
            // Broadcast Status Loop (Heartbeat)
            setInterval(() => {
                if(isHost && mainVid && conn) {
                    conn.send({
                        type: 'stream-info', 
                        time: mainVid.currentTime, 
                        duration: mainVid.duration,
                        isPlaying: !mainVid.paused
                    });
                    updateProgressUI(mainVid.currentTime, mainVid.duration);
                }
            }, 500); // 2Hz update rate

            // Auto-start Face Call
            startCall(); 
        }

        function enterTheaterMode() {
            document.getElementById('theater-mode').style.display = 'flex';
            resetControlsTimer();
        }

        function exitTheater() {
            document.getElementById('theater-mode').style.display = 'none';
            const vid = document.getElementById('main-video');
            vid.pause();
            // Optional: Close stream?
        }

        // --- PLAYER CONTROLS UI ---
        function toggleControls() {
            if(isLocked) return;
            const overlay = document.getElementById('controls-overlay');
            if(overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
                resetControlsTimer();
            } else {
                overlay.classList.add('hidden');
            }
        }

        function resetControlsTimer() {
            clearTimeout(controlsTimeout);
            controlsTimeout = setTimeout(() => {
                if(!isLocked) document.getElementById('controls-overlay').classList.add('hidden');
            }, 3000);
        }

        function togglePlay() {
            if(isHost) {
                const vid = document.getElementById('main-video');
                if(vid.paused) vid.play(); else vid.pause();
                updatePlayIcon(!vid.paused);
            } else {
                // Peer sends command to Host
                // Guess current state from UI icon
                const isPlaying = document.getElementById('center-play-icon').getAttribute('data-lucide') === 'pause';
                conn.send({type: 'remote-command', action: isPlaying ? 'pause' : 'play'});
            }
            resetControlsTimer();
        }

        function updatePlayIcon(isPlaying) {
            const icon = document.getElementById('center-play-icon');
            icon.setAttribute('data-lucide', isPlaying ? 'pause' : 'play');
            lucide.createIcons();
        }

        function seekRelative(seconds) {
            if(isHost) {
                const vid = document.getElementById('main-video');
                vid.currentTime += seconds;
            } else {
                // Peer needs to know current time to calculate relative
                // We rely on the last updated time from UI
                const currStr = document.getElementById('curr-time').innerText;
                const curr = parseTime(currStr);
                conn.send({type: 'remote-command', action: 'seek', time: curr + seconds});
            }
            resetControlsTimer();
        }

        function seekTo(e) {
            const bar = document.getElementById('progress-bar');
            const rect = bar.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            
            if(isHost) {
                const vid = document.getElementById('main-video');
                vid.currentTime = pos * vid.duration;
            } else {
                // Peer calculates target time based on total duration (received from host)
                if(peerDuration > 0) {
                    const target = pos * peerDuration;
                    conn.send({type: 'remote-command', action: 'seek', time: target});
                }
            }
        }

        function updateProgressUI(curr, total) {
            if(!total) return;
            document.getElementById('curr-time').innerText = formatTime(curr);
            document.getElementById('total-time').innerText = formatTime(total);
            const pct = (curr / total) * 100;
            document.getElementById('progress-filled').style.width = pct + '%';
        }

        function formatTime(s) {
            if(!s) return "00:00";
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0'+sec : sec}`;
        }
        function parseTime(str) {
            const p = str.split(':');
            return parseInt(p[0])*60 + parseInt(p[1]);
        }

        function toggleFit() {
            const vid = document.getElementById('main-video');
            const current = vid.style.objectFit;
            vid.style.objectFit = (current === 'cover') ? 'contain' : (current === 'contain' ? 'fill' : 'cover');
        }

        function toggleLock() {
            isLocked = !isLocked;
            const icon = document.getElementById('lock-icon');
            icon.setAttribute('data-lucide', isLocked ? 'lock' : 'unlock');
            icon.style.color = isLocked ? 'var(--red)' : 'white';
            lucide.createIcons();
            if(!isLocked) resetControlsTimer();
        }

        // --- CALL LOGIC ---
        function startCall() {
            const vidConstraint = { width: { ideal: 320 }, height: { ideal: 240 } };
            navigator.mediaDevices.getUserMedia({video: vidConstraint, audio:true}).then(stream => {
                localStream = stream;
                document.getElementById('self-pip').srcObject = stream;
                
                // Update theater controls state
                updateCallButtonsState();

                const call = peer.call(conn.peer, stream);
                activeCall = call;
                call.on('stream', (remoteStream) => {
                    document.getElementById('peer-pip').srcObject = remoteStream;
                });
            }).catch(e => {
                console.log("Mic/Cam permission needed for call");
            });
        }

        function toggleMic() {
            if(localStream) {
                const track = localStream.getAudioTracks()[0];
                track.enabled = !track.enabled;
                updateCallButtonsState();
            } else startCall();
        }

        function toggleCam() {
            if(localStream) {
                const track = localStream.getVideoTracks()[0];
                track.enabled = !track.enabled;
                document.getElementById('self-pip').style.opacity = track.enabled ? '1' : '0';
                updateCallButtonsState();
            } else startCall();
        }

        function updateCallButtonsState() {
            if(!localStream) return;
            const micOn = localStream.getAudioTracks()[0].enabled;
            const camOn = localStream.getVideoTracks()[0].enabled;
            
            const micBtn = document.getElementById('tm-mic');
            const camBtn = document.getElementById('tm-cam');
            
            micBtn.classList.toggle('active-red', !micOn);
            micBtn.querySelector('i').setAttribute('data-lucide', micOn ? 'mic' : 'mic-off');
            
            camBtn.classList.toggle('active-red', !camOn);
            camBtn.querySelector('i').setAttribute('data-lucide', camOn ? 'camera' : 'camera-off');
            
            lucide.createIcons();
        }

        // --- CHAT & FILE LOGIC ---
        let fileQueue = [], activeTransfer = null, isTransferring = false, receiving = {};
        document.getElementById('file-input').onchange = function() {
            for(let f of this.files) {
                const id = Date.now() + Math.random().toString(36).substr(2, 5);
                fileQueue.push({file:f, id:id});
                createFileUI(id, f.name, 'Sending');
            }
            processFileQueue();
            this.value = '';
        };

        function createFileUI(id, name, type) {
            const div = document.createElement('div'); div.className='transfer-item'; div.id=`file-${id}`;
            div.innerHTML = `<div class="t-info"><span class="t-name">${name}</span></div><div class="t-bar-bg"><div class="t-bar-fill" id="bar-${id}"></div></div>`;
            document.getElementById('transfer-list').prepend(div);
        }

        function processFileQueue() {
            if(isTransferring || fileQueue.length===0 || !conn) return;
            const item = fileQueue.shift(); activeTransfer = item; isTransferring = true;
            conn.send({type:'file-meta', fileId:item.id, name:item.file.name, size:item.file.size});
            const reader = new FileReader(); let offset=0;
            reader.onload = (e) => {
                if(conn) {
                    conn.send({type:'file-chunk', fileId:item.id, data:e.target.result});
                    offset += e.target.result.byteLength;
                    document.getElementById(`bar-${item.id}`).style.width = Math.round((offset/item.file.size)*100)+'%';
                    if(offset < item.file.size) reader.readAsArrayBuffer(item.file.slice(offset, offset+16384));
                    else { isTransferring=false; setTimeout(processFileQueue, 50); }
                }
            };
            reader.readAsArrayBuffer(item.file.slice(0, 16384));
        }

        function startReceivingFile(meta) { receiving[meta.fileId] = {name:meta.name, size:meta.size, received:0, buffer:[]}; createFileUI(meta.fileId, meta.name, 'Receiving'); }
        function processFileChunk(data) {
            const f = receiving[data.fileId]; if(!f) return;
            f.buffer.push(data.data); f.received+=data.data.byteLength;
            document.getElementById(`bar-${data.fileId}`).style.width = Math.round((f.received/f.size)*100)+'%';
            if(f.received >= f.size) {
                const blob = new Blob(f.buffer); const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href=url; a.download=f.name; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                delete receiving[data.fileId];
            }
        }

        function sendText() {
            const val = document.getElementById('msg-input').value.trim();
            if(!val || !conn) return;
            conn.send({type:'text', content:val});
            addMessage(val, 'sent');
            document.getElementById('msg-input').value = '';
        }
        function addMessage(text, type) {
            const div = document.createElement('div'); div.className = `msg ${type}`;
            div.innerText = text;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 100000;
        }
        function addImage(src, type, id) {
            const div = document.createElement('div'); div.className = `msg ${type}`;
            div.innerHTML = `<img src="${src}" onclick="openModal('${src}')">`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 100000;
        }
        function openModal(src) { document.getElementById('img-modal').style.display='flex'; document.getElementById('modal-img').src=src; document.getElementById('modal-dl').href=src; }

        let qrScanner;
        function startScanner() {
            document.getElementById('scanner-overlay').style.display = 'flex';
            if(!qrScanner) qrScanner = new Html5Qrcode("qr-reader");
            qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, t => {
                stopScanner();
                let id = t.includes('#') ? t.split('#')[1] : t;
                if(id) { window.location.hash = id; window.location.reload(); }
            }).catch(e => alert("Camera blocked"));
        }
        function stopScanner() { 
            if(qrScanner) qrScanner.stop().then(()=>document.getElementById('scanner-overlay').style.display='none');
            else document.getElementById('scanner-overlay').style.display='none';
        }
        function shareQRCode() {
            const canvas = document.querySelector('#qrcode canvas');
            if(canvas) canvas.toBlob(blob => navigator.share({files:[new File([blob],"qr.png",{type:"image/png"})]}).catch(e=>{}));
        }

        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onmousedown = dragMouseDown;
            elmnt.ontouchstart = dragTouchStart;
            function dragMouseDown(e) { e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; }
            function elementDrag(e) { e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; }
            function dragTouchStart(e) { pos3 = e.touches[0].clientX; pos4 = e.touches[0].clientY; document.ontouchend = closeDragElement; document.ontouchmove = elementTouchDrag; }
            function elementTouchDrag(e) { pos1 = pos3 - e.touches[0].clientX; pos2 = pos4 - e.touches[0].clientY; pos3 = e.touches[0].clientX; pos4 = e.touches[0].clientY; elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; }
            function closeDragElement() { document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null; }
        }
    </script>
</body>
</html>
